name: Reusable K8s Deployment PR

on:
  workflow_call:
    inputs:
      iac_repository:
        description: "Infrastructure-as-Code repository (e.g., 'Integrosa/cluster-iac')"
        required: false
        type: string
        default: "Integrosa/cluster-iac"
      app_name:
        description: "Application name for PR title and commit message"
        required: true
        type: string
      k8s_namespace:
        description: "Kubernetes namespace path (e.g., 'k3s/apps/wrpiano')"
        required: true
        type: string
      deployment_files:
        description: "Space-separated list of deployment files to update (relative to k8s_namespace)"
        required: false
        type: string
        default: "deployment.yaml"
      docker_image_path:
        description: "Base Docker image path without tag (from build workflow)"
        required: true
        type: string
      docker_image_full:
        description: "Full Docker image with version tag (from build workflow)"
        required: true
        type: string
      version_tag:
        description: "Version tag (e.g., 'v1.2.3')"
        required: true
        type: string
      commit_message:
        description: "Original commit message from source repository"
        required: false
        type: string
        default: ""
      runs_on:
        description: "Runner to use for the deployment job"
        required: false
        type: string
        default: "homelab"
      pr_labels:
        description: "Comma-separated list of labels to add to the PR"
        required: false
        type: string
        default: "automated,deployment"
      environment:
        description: "Deployment environment (e.g., 'staging', 'production')"
        required: false
        type: string
        default: "production"
    secrets:
      iac_token:
        description: "GitHub token with write access to IaC repository"
        required: true

jobs:
  create-deployment-pr:
    runs-on: ${{ inputs.runs_on }}
    permissions:
      contents: read

    steps:
    - name: Checkout source repository (for commit info)
      uses: actions/checkout@v4

    - name: Get commit message
      id: commit
      run: |
        if [ -n "${{ inputs.commit_message }}" ]; then
          # Use provided commit message
          echo "message=${{ inputs.commit_message }}" >> $GITHUB_OUTPUT
        else
          # Get latest commit message
          MSG=$(git log -1 --pretty=%B | head -1)
          echo "message=$MSG" >> $GITHUB_OUTPUT
        fi

    - name: Checkout IaC repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.iac_repository }}
        token: ${{ secrets.iac_token }}
        path: iac-repo

    - name: Update deployment files
      run: |
        cd iac-repo/${{ inputs.k8s_namespace }}

        # Update each deployment file
        for file in ${{ inputs.deployment_files }}; do
          if [ -f "$file" ]; then
            echo "Updating $file..."
            sed -i 's|image: ${{ inputs.docker_image_path }}:.*|image: ${{ inputs.docker_image_full }}|g' "$file"
          else
            echo "Warning: File $file not found, skipping..."
          fi
        done

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        path: iac-repo
        token: ${{ secrets.iac_token }}
        commit-message: "deploy(${{ inputs.app_name }}): update to ${{ inputs.version_tag }}"
        branch: "deploy/${{ inputs.app_name }}-${{ inputs.version_tag }}"
        delete-branch: true
        title: "ğŸš€ Deploy ${{ inputs.app_name }} ${{ inputs.version_tag }} to ${{ inputs.environment }}"
        labels: ${{ inputs.pr_labels }}
        body: |
          ## ğŸ¤– Automated Deployment PR

          This PR was automatically generated by the CI/CD pipeline.

          ### ğŸ“¦ Release Info
          | | |
          |---|---|
          | **Application** | `${{ inputs.app_name }}` |
          | **Version** | `${{ inputs.version_tag }}` |
          | **Environment** | `${{ inputs.environment }}` |
          | **Image** | `${{ inputs.docker_image_full }}` |
          | **Namespace** | `${{ inputs.k8s_namespace }}` |
          | **Commit** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
          | **Change** | ${{ steps.commit.outputs.message }} |

          ### ğŸ“ Updated Files
          ```
          ${{ inputs.deployment_files }}
          ```

          ### âœ… Merge to Deploy
          Merging this PR will trigger ArgoCD to deploy the new version to **${{ inputs.environment }}**.

          ---

          ğŸ¤– Generated by [Integrosa Reusable Workflows](https://github.com/Integrosa/.github)
